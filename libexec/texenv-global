#!/usr/bin/env bash

declare -r TEXENV_DEBUG
[[ "${TEXENV_DEBUG}" == 1 ]] && set -x
set -euo pipefail

# Set global TeX Live version
cmdGlobal() {
  declare VERSION
  declare SCRIPT_NAME
  declare libs
  SCRIPT_NAME="${0##*/}"
  libs="$(type -P "texenv-libs" || true)"
  case "${1:-}" in
    -h | --help)
      builtin echo "Usage: ${SCRIPT_NAME%%-*} ${SCRIPT_NAME##*-} [options] <version>"
      builtin echo "Set global TeX Live version"
      builtin echo "Options:"
      builtin echo "  -h, --help  Show this help message"
      exit 0
      ;;
    *)
      VERSION="${1:-}"
      ;;
  esac
  [[ -d "${TEXENV_VERSIONS}/${VERSION}" ]] || {
    builtin echo "texenv: version ${VERSION} is not installed" >&2
    exit 1
  }
  [[ -z "${VERSION}" ]] && {
    if [[ -d "${TEXENV_VERSIONS}" ]]; then
      TEX_VERSION_INFO="$("${libs}" resolveVersion || true)"
      VERSION="$(awk -F": " '/TinyTeX-Version: /{print $2}' <<< "${TEX_VERSION_INFO}")"
      [[ -z "${VERSION}" ]] && {
        builtin echo "texenv: no version set (use 'texenv global <version>')" >&2
        exit 1
      }
      builtin echo "${VERSION}"
      exit 0
    else
      builtin echo "texenv: no version set (use 'texenv global <version>')" >&2
      exit 1
    fi
  }
  {
    builtin echo "${VERSION}" > "${TEXENV_ROOT}/${TEX_GLOBAL_VERSION_FILE}"
  } || {
    builtin echo "texenv: failed to set global version" >&2
    exit 1
  }
}

cmdGlobal "${@}"
