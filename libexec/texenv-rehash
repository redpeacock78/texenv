#!/usr/bin/env bash

declare TEXENV_DEBUG
[[ "${TEXENV_DEBUG}" == 1 ]] && set -x
set -euo pipefail

# Rebuild shims for installed TeX Live versions
cmdRehash() {
  declare CMD_LIST
  declare SCRIPT_NAME
  declare TMP_SHIMS
  declare BACKUP_SHIMS
  SCRIPT_NAME="${0##*/}"
  case "${1:-}" in
    -h | --help)
      builtin echo "Usage: ${SCRIPT_NAME%%-*} ${SCRIPT_NAME##*-}"
      builtin echo "Rebuild shims for installed TeX Live versions"
      builtin echo "Options:"
      builtin echo "  -h, --help  Show this help message"
      exit 0
      ;;
  esac
  [[ ! -d "${TEXENV_VERSIONS}" ]] && {
    builtin echo "texenv: no versions installed" >&2
    exit 1
  }
  CMD_LIST="$(find "${TEXENV_VERSIONS}" -path "*/bin/${TEXENV_PLATFORM}/*" ! -type d -exec bash -c 'for f in "${@}"; do [[ -x "${f}" ]] && builtin echo "${f}"; done' _ {} +)"
  [[ -z "${CMD_LIST}" ]] && {
    builtin echo "texenv: no commands found in installed versions" >&2
    exit 1
  }
  cleanup() {
    [[ -n "${BACKUP_SHIMS:-}" && -d "${BACKUP_SHIMS}" ]] && mv "${BACKUP_SHIMS}" "${TEXENV_SHIMS}"
    [[ -n "${TMP_SHIMS:-}" && -d "${TMP_SHIMS}" ]] && rm -rf "${TMP_SHIMS:?}"
    builtin echo "texenv: rehash failed" >&2
    exit 1
  }
  trap cleanup ERR INT TERM
  [[ -d "${TEXENV_SHIMS}" ]] && {
    BACKUP_SHIMS="${TEXENV_SHIMS}.bak.${$}"
    mv "${TEXENV_SHIMS}" "${BACKUP_SHIMS}"
  }
  TMP_SHIMS="$(mktemp -d "${TEXENV_ROOT}/.temp_shims_XXXXXX")"
  awk -F/ '!a[$NF]++{print $NF}' <<< "${CMD_LIST}" |
    while read -r CMD; do
      declare SHIM_PATH="${TMP_SHIMS}/${CMD}"
      {
        builtin echo "#!/usr/bin/env bash"
        builtin echo "[[ \"\${TEXENV_DEBUG}\" == 1 ]] && set -x"
        builtin echo "set -euo pipefail"
        builtin echo "shim() {"
        builtin echo "  declare -r CMD_PATH=\"\$(builtin cd \"\${0%/*}\" && builtin echo \"\${PWD/shims/bin}\")\""
        builtin echo "  declare -r CMD_NAME=\"\${0##*/}\""
        builtin echo "  exec \"\${CMD_PATH}/texenv\" exec \"\${CMD_NAME}\" \"\${@}\""
        builtin echo "}"
        builtin echo "shim \"\${@}\""
      } > "${SHIM_PATH}"
      chmod +x "${SHIM_PATH}"
    done
  builtin echo "${CMD_LIST}" > "${TEX_CMD_LIST_CACHE}"
  mv "${TMP_SHIMS}" "${TEXENV_SHIMS}"
  [[ -n "${BACKUP_SHIMS:-}" && -d "${BACKUP_SHIMS}" ]] && rm -rf "${BACKUP_SHIMS:?}"
  trap - ERR INT TERM
}

cmdRehash "${@}"
