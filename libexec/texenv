#!/usr/bin/env bash
#
# @(#)texenv
# @(#)(c) 2025 redpeacock78
# @(#)MIT License is applied to this script.
########################################
# @(#)A lightweight version manager for TinyTeX (minimal TeX Live) inspired by rbenv.
# @(#)It lets you install multiple TinyTeX releases side‑by‑side, select global or per‑project versions, expose TeX executables through shims, and freeze / restore package sets.
# @(#)Depends:
# @(#)  shift
# @(#)  mkdir
# @(#)  uname
# @(#)  grep
# @(#)  bash
# @(#)  curl
# @(#)  perl
# @(#)  find
# @(#)  exec
# @(#)  sort
# @(#)  test
# @(#)  awk
# @(#)  cat
# @(#)  tar
# @(#)  tr
# @(#)  rm
########################################

declare -r TEXENV_DEBUG
[[ "${TEXENV_DEBUG}" == 1 ]] && set -x
set -euo pipefail

perl -mFile::Find /dev/null || {
  builtin echo "perl is required but not found (https://github.com/rstudio/tinytex/issues/419)" >&2
  exit 1
}

OS_NAME="$(uname)"
declare -r OS_NAME
if [[ "${OS_NAME}" == "Darwin" ]]; then
  declare -r TEXENV_PLATFORM="universal-darwin"
  declare -r TINYTEX_ARCHIVE_EXT="tgz"
elif [[ "${OS_NAME}" == "Linux" ]]; then
  declare -r TEXENV_PLATFORM="x86_64-linux"
  declare -r TINYTEX_ARCHIVE_EXT="tar.gz"
else
  builtin echo "texenv: unsupported OS '${OS_NAME}'" >&2
  exit 1
fi
declare -r TEXENV_ROOT="${TEXENV_ROOT:-${HOME}/.texenv}"
declare -r TEXENV_VERSIONS="${TEXENV_ROOT}/versions"
declare -r TEXENV_CONFIG="${TEXENV_ROOT}/config"
declare -r TEXENV_BIN="${TEXENV_ROOT}/bin"
declare -r TEXENV_SHIMS="${TEXENV_ROOT}/shims"
declare -r TEXMF_HOME="${TEXENV_ROOT}/texmf"
declare -r TEX_GLOBAL_VERSION_FILE="version"
declare -r TEX_LOCAL_VERSION_FILE=".tex-version"
declare -r TEX_REQUIREMENTS_FILE="tex-require.txt"
declare -r TEX_REQUIREMENTS_LOCK_FILE="tex-require.lock"
declare -r TEX_CMD_LIST_CACHE="${TEXENV_CONFIG}/cmd_list_cache.txt"

export TEXENV_PLATFORM
export TINYTEX_ARCHIVE_EXT
export TEXENV_ROOT
export TEXENV_VERSIONS
export TEXENV_CONFIG
export TEXENV_BIN
export TEXENV_SHIMS
export TEXMF_HOME
export TEX_GLOBAL_VERSION_FILE
export TEX_LOCAL_VERSION_FILE
export TEX_REQUIREMENTS_FILE
export TEX_REQUIREMENTS_LOCK_FILE
export TEX_CMD_LIST_CACHE

# Read symbolic link to get absolute path
readLinkFile() {
  [ "${1:+x}" ] || return 1
  p="${1}"
  until [ "${p%/}" = "${p}" ]; do p="${p%/}"; done
  [ -e "${p}" ] && p="${1}"
  [ -d "${1}" ] && p="${p}/"
  set 10 "${PWD}" "${OLDPWD:-}"
  CDPATH="" builtin cd -P "${2}" && while [ "${1}" -gt 0 ]; do
    set "${1}" "${2}" "${3}" "${p%/*}"
    [ "${p}" = "${4}" ] || {
      CDPATH="" builtin cd -P "${4:-/}" || break
      p=${p##*/}
    }
    [ ! -L "${p}" ] && p=${PWD%/}${p:+/}${p} && set "$@" "${p:-/}" && break
    set $((${1} - 1)) "${2}" "${3}" "${p}"
    p=$(ls -dl "${p}") || break
    p=${p#*" $4 -> "}
  done 2> /dev/null
  builtin cd -L "${2}" && OLDPWD=${3} && [ ${5+x} ] && builtin printf '%s\n' "${5}"
}

TEXENV_LIBEXEC="$(readLinkFile "${BASH_SOURCE:-$0}")"
declare -r TEXENV_LIBEXEC
export PATH="${TEXENV_LIBEXEC%/*}:${PATH}"

main() {
  declare CMD_NAME
  declare CMD_PATH
  CMD_NAME="${1:-}"
  CMD_PATH="$(type -P "texenv-${CMD_NAME##*-}" || true)"
  shift || true
  case "${CMD_NAME:-}" in
    init) exec "${CMD_PATH}" "${@}" ;;
    install) exec "${CMD_PATH}" "${@}" ;;
    uninstall) exec "${CMD_PATH}" "${@}" ;;
    version) exec "${CMD_PATH}" "${@}" ;;
    versions) exec "${CMD_PATH}" "${@}" ;;
    global) exec "${CMD_PATH}" "${@}" ;;
    local) exec "${CMD_PATH}" "${@}" ;;
    repo) exec "${CMD_PATH}" "${@}" ;;
    exec) exec "${CMD_PATH}" "${@}" ;;
    rehash) exec "${CMD_PATH}" "${@}" ;;
    freeze) exec "${CMD_PATH}" "${@}" ;;
    restore) exec "${CMD_PATH}" "${@}" ;;
    which) exec "${CMD_PATH}" "${@}" ;;
    where) exec "${CMD_PATH}" "${@}" ;;
    whence) exec "${CMD_PATH}" "${@}" ;;
    env) exec "${CMD_PATH}" ;;
    help | -h | --help) exec "${CMD_PATH}" ;;
    *)
      [[ -n "${CMD_NAME}" ]] && builtin echo "texenv: unknown command '${CMD_NAME}'" >&2
      builtin echo "Run '${0##*/} help' for usage." >&2
      exit 1
      ;;
  esac
}

main "${@}"
